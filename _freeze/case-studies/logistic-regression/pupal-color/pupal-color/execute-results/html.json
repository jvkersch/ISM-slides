{
  "hash": "012946d16624d5237bb0eaa55c61a761",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Determinants of pupal color\"\nformat: html\n---\n\n\nBased on Mayekar and Kodandaramaiah (2017), as discussed in Quinn and Keogh, p. 261.\n\n- Data is really unbalanced and not really well separated, hard to get a good classifier.\n\n\n# EDA\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.2     ✔ readr     2.1.4\n✔ forcats   1.0.0     ✔ stringr   1.5.0\n✔ ggplot2   3.5.0     ✔ tibble    3.2.1\n✔ lubridate 1.9.2     ✔ tidyr     1.3.0\n✔ purrr     1.0.1     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n:::\n\n\n\nExplanation of the variables:\n\n- `PC`: Pupal colour\n- `H`: Relative humidity\n- `SU`: Pupation substrate\n- `T`: Time to pupation\n- `S`: Sex\n- `W`: Pupal weight\t\n\n\n::: {.cell}\n\n```{.r .cell-code}\npupal <- read.csv(\"pone.0171482.s005.csv\", header = TRUE)\nhead(pupal)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    H    PC  T       SU      S      W\n1 low green 19     leaf   male 0.1590\n2 low green 21     leaf female 0.2511\n3 low green 19     leaf   male 0.2289\n4 low green 21 off-leaf   male 0.1960\n5 low green 21 off-leaf   male 0.1178\n6 low green 21 off-leaf female 0.2312\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(pupal)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 701\nColumns: 6\n$ H  <chr> \"low\", \"low\", \"low\", \"low\", \"low\", \"low\", \"low\", \"low\", \"low\", \"low…\n$ PC <chr> \"green\", \"green\", \"green\", \"green\", \"green\", \"green\", \"green\", \"gre…\n$ T  <int> 19, 21, 19, 21, 21, 21, 21, 21, 21, 19, 19, 19, 19, 19, 17, 23, 23,…\n$ SU <chr> \"leaf\", \"leaf\", \"leaf\", \"off-leaf\", \"off-leaf\", \"off-leaf\", \"off-le…\n$ S  <chr> \"male\", \"female\", \"male\", \"male\", \"male\", \"female\", \"female\", \"male…\n$ W  <dbl> 0.1590, 0.2511, 0.2289, 0.1960, 0.1178, 0.2312, 0.2409, 0.1958, 0.1…\n```\n\n\n:::\n:::\n\n\n## Color against humidity\n\n\n::: {.cell}\n\n```{.r .cell-code}\nxtabs(~ PC + H, data = pupal)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       H\nPC      high low\n  brown    2  28\n  green  311 360\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npupal_low_humidity <- pupal |>\n  filter(H == \"low\")\n```\n:::\n\n\n## Effect of time to gestation on pupal color\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(pupal_low_humidity, aes(x = T, y = PC, color = PC)) +\n  geom_jitter()\n```\n\n::: {.cell-output-display}\n![](pupal-color_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(pupal_low_humidity, aes(x = T, y = PC, fill = PC)) +\n  geom_boxplot()\n```\n\n::: {.cell-output-display}\n![](pupal-color_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwilcox.test(T ~ PC, data = pupal_low_humidity)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tWilcoxon rank sum test with continuity correction\n\ndata:  T by PC\nW = 2802, p-value = 8.468e-05\nalternative hypothesis: true location shift is not equal to 0\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(pupal_low_humidity, aes(x = T, y = W, color = PC)) +\n  geom_jitter()\n```\n\n::: {.cell-output-display}\n![](pupal-color_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n\n# Multi-predictor model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm <- glm(factor(PC) ~ T + W + S, data = pupal_low_humidity, family = \"binomial\")\nsummary(m)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = factor(PC) ~ T + W + S, family = \"binomial\", data = pupal_low_humidity)\n\nCoefficients:\n            Estimate Std. Error z value Pr(>|z|)    \n(Intercept) -3.22297    2.33228  -1.382 0.167005    \nT            0.22058    0.06296   3.504 0.000459 ***\nW            0.44017    6.35219   0.069 0.944755    \nSmale        0.25680    0.43507   0.590 0.555023    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 201.14  on 387  degrees of freedom\nResidual deviance: 183.93  on 384  degrees of freedom\nAIC: 191.93\n\nNumber of Fisher Scoring iterations: 6\n```\n\n\n:::\n:::\n\n\n# Model building\n\nThis is \"analysis 2\" in the paper.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm_interaction <- glm(factor(PC) ~ T + W + S + T:W + T:S + W:S + T:W:S, data = pupal_low_humidity, family = \"binomial\")\nsummary(m_interaction)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = factor(PC) ~ T + W + S + T:W + T:S + W:S + T:W:S, \n    family = \"binomial\", data = pupal_low_humidity)\n\nCoefficients:\n            Estimate Std. Error z value Pr(>|z|)\n(Intercept)  -4.3574    11.5352  -0.378    0.706\nT             0.3200     0.4704   0.680    0.496\nW             6.0282    55.4602   0.109    0.913\nSmale       -11.9309    16.9166  -0.705    0.481\nT:W          -0.4882     2.2895  -0.213    0.831\nT:Smale       0.3403     0.6760   0.503    0.615\nW:Smale      67.8920    87.3741   0.777    0.437\nT:W:Smale    -1.9455     3.5268  -0.552    0.581\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 201.14  on 387  degrees of freedom\nResidual deviance: 180.92  on 380  degrees of freedom\nAIC: 196.92\n\nNumber of Fisher Scoring iterations: 6\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(faraway)\nvif(m_interaction)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        T         W     Smale       T:W   T:Smale   W:Smale T:W:Smale \n 1824.307  1571.240 27463.454  2469.656 32550.223 23208.433 26758.714 \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncpupal <- pupal_low_humidity |>\n  mutate(cT = T - mean(T), cW = W - mean(W)) |>\n  select(PC, cT, cW, S)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nm_centered <- glm(factor(PC) ~ cT * cW * S, data = cpupal, family = \"binomial\")\nsummary(m_centered)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = factor(PC) ~ cT * cW * S, family = \"binomial\", \n    data = cpupal)\n\nCoefficients:\n            Estimate Std. Error z value Pr(>|z|)    \n(Intercept)  2.93819    0.38024   7.727  1.1e-14 ***\ncT           0.22977    0.09352   2.457    0.014 *  \ncW          -7.10539   10.06451  -0.706    0.480    \nSmale        0.09931    0.60867   0.163    0.870    \ncT:cW       -0.48820    2.28947  -0.213    0.831    \ncT:Smale    -0.01935    0.13493  -0.143    0.886    \ncW:Smale    15.55302   16.02256   0.971    0.332    \ncT:cW:Smale -1.94554    3.52682  -0.552    0.581    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 201.14  on 387  degrees of freedom\nResidual deviance: 180.92  on 380  degrees of freedom\nAIC: 196.92\n\nNumber of Fisher Scoring iterations: 6\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nm_final <- step(m_centered)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nStart:  AIC=196.92\nfactor(PC) ~ cT * cW * S\n\n          Df Deviance    AIC\n- cT:cW:S  1   181.19 195.19\n<none>         180.92 196.92\n\nStep:  AIC=195.19\nfactor(PC) ~ cT + cW + S + cT:cW + cT:S + cW:S\n\n        Df Deviance    AIC\n- cT:S   1   181.21 193.21\n- cT:cW  1   181.62 193.62\n<none>       181.19 195.19\n- cW:S   1   183.46 195.46\n\nStep:  AIC=193.2\nfactor(PC) ~ cT + cW + S + cT:cW + cW:S\n\n        Df Deviance    AIC\n- cT:cW  1   181.66 191.66\n<none>       181.21 193.21\n- cW:S   1   183.77 193.77\n\nStep:  AIC=191.66\nfactor(PC) ~ cT + cW + S + cW:S\n\n       Df Deviance    AIC\n<none>      181.66 191.66\n- cW:S  1   183.93 191.93\n- cT    1   197.48 205.48\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(m_final)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = factor(PC) ~ cT + cW + S + cW:S, family = \"binomial\", \n    data = cpupal)\n\nCoefficients:\n            Estimate Std. Error z value Pr(>|z|)    \n(Intercept)  2.95396    0.35505   8.320  < 2e-16 ***\ncT           0.23278    0.06423   3.624  0.00029 ***\ncW          -5.42775    7.44301  -0.729  0.46585    \nSmale        0.22677    0.46867   0.484  0.62848    \ncW:Smale    19.05204   12.53357   1.520  0.12849    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 201.14  on 387  degrees of freedom\nResidual deviance: 181.66  on 383  degrees of freedom\nAIC: 191.66\n\nNumber of Fisher Scoring iterations: 6\n```\n\n\n:::\n:::\n\n\nComparison of AIC:\n\n::: {.cell}\n\n```{.r .cell-code}\nAIC(m_final)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 191.656\n```\n\n\n:::\n\n```{.r .cell-code}\nAIC(m)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 191.9332\n```\n\n\n:::\n:::\n\n\nNote that we could further simplify the model by removing `W` and `S`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm_simple <-  glm(factor(PC) ~ T, data = pupal_low_humidity, family = \"binomial\")\nsummary(m_simple)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = factor(PC) ~ T, family = \"binomial\", data = pupal_low_humidity)\n\nCoefficients:\n            Estimate Std. Error z value Pr(>|z|)    \n(Intercept) -2.90171    1.42355  -2.038 0.041514 *  \nT            0.21562    0.05867   3.675 0.000238 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 201.14  on 387  degrees of freedom\nResidual deviance: 184.31  on 386  degrees of freedom\nAIC: 188.31\n\nNumber of Fisher Scoring iterations: 6\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nAIC(m_simple)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 188.3055\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npupal_low_humidity |>\n  mutate(pred = predict(m_simple, type = \"response\")) |>\n  ggplot() +\n  geom_line(aes(x = T, y = pred))\n```\n\n::: {.cell-output-display}\n![](pupal-color_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(caret)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: lattice\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'lattice'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:faraway':\n\n    melanoma\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'caret'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:purrr':\n\n    lift\n```\n\n\n:::\n\n```{.r .cell-code}\npred_test <- predict(m_simple, pupal_low_humidity, type=\"response\")\nclass_test <- ifelse(pred_test >= 0.8, \"brown\", \"green\")\n\nconf_matrix <- confusionMatrix(as.factor(class_test), as.factor(pupal_low_humidity$PC), positive = \"green\")\nprint(conf_matrix)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nConfusion Matrix and Statistics\n\n          Reference\nPrediction brown green\n     brown    27   347\n     green     1    13\n                                          \n               Accuracy : 0.1031          \n                 95% CI : (0.0747, 0.1377)\n    No Information Rate : 0.9278          \n    P-Value [Acc > NIR] : 1               \n                                          \n                  Kappa : 1e-04           \n                                          \n Mcnemar's Test P-Value : <2e-16          \n                                          \n            Sensitivity : 0.03611         \n            Specificity : 0.96429         \n         Pos Pred Value : 0.92857         \n         Neg Pred Value : 0.07219         \n             Prevalence : 0.92784         \n         Detection Rate : 0.03351         \n   Detection Prevalence : 0.03608         \n      Balanced Accuracy : 0.50020         \n                                          \n       'Positive' Class : green           \n                                          \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(pROC)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nType 'citation(\"pROC\")' for a citation.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'pROC'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:stats':\n\n    cov, smooth, var\n```\n\n\n:::\n\n```{.r .cell-code}\npred_test <- predict(m_simple, pupal_low_humidity, type=\"response\")\nroc_logis <- roc(pupal_low_humidity$PC, pred_test)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nSetting levels: control = brown, case = green\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nSetting direction: controls < cases\n```\n\n\n:::\n\n```{.r .cell-code}\nauc <- round(auc(pupal_low_humidity$PC, pred_test), 4)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nSetting levels: control = brown, case = green\nSetting direction: controls < cases\n```\n\n\n:::\n\n```{.r .cell-code}\nggroc(roc_logis) +\n    ggtitle(paste0('ROC Curve ', '(AUC = ', auc, ')'))\n```\n\n::: {.cell-output-display}\n![](pupal-color_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "pupal-color_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}